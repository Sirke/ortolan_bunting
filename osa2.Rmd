---
title: "Ortolan Bunting analysis"
author: "me"
date: "9 joulukuuta 2019"
output: html_document
---

# Peltosirkkuaineiston analyysi

Tutkimuskysymykset:  

1) Peltosirkun häviämisnopeus kasvaa alueen avoimuuden vähentyessä ja eristyneisyyden kasvaessa  

2) Peltosirkun häviämisnopeus kasvaa peltoviljelyn muuttuessa viljavaltaisesta nurmivaltaiseksi  

3) Peltosirkun häviämisnopeus kasvaa viljelyn monimuotoisuuden vähentyessä  

4) Peltosirkun häviämisnopeus kasvaa maiseman pienipiirteisten rakenteiden yksipuolistuessa  



```{r, include=FALSE}
getwd()
paketit<-c("readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","glmmTMB","lme4","MASS","MuMIn","mgcv")
lapply(paketit,library,character.only=T)
```


## Aineiston tarkastelua

```{r}
data<-read.csv("OrtolanBunting.csv")

names(data)
str(data)
summary(data)

#tarkasta kaikkien luokkien muoto
data$id<-as.factor(data$id)
#vuodelle oma faktori-muuttuja
data$fyear<-as.factor(data$year)
```

### Poikkeavia havaintoja

```{r}
#outliers
dotchart(data$terri, main= "territories")
dotchart(data$prec, main= "precipitation")
dotchart(data$temp, main= "temperature")
dotchart(data$open, main= "spring sown")
dotchart(data$SSS, main= "small-scale structures")

hist(data$terri)

#kuinka monta käyntikertaa per osapopulaatio?
table(data$id)
```

Aineistossa on muutama MEGAosapopulaatio. Suurimmaksi osaksi pienempiä.  

Muutamalla osapopulaatiolla on käyty vain kerran.


### Riippuvuussuhteita

```{r, fig.width=14, fig.height=12}
#relationships
pairs.panels(data[,c(3:21)])
```

Reviirien lukumäärällä (terri) ja Shannon-Wienerin indeksillä (shan) on suht vahva korrelaatio. Keväällä kylvettävien kasvien osuus (open) ja keväällä pitkällä oraalla olevien kasvien (cover) osuudet ovat toistensa vastakohdat. Myös maatalousmaiseman osuus (agri5) ja pienrakenteiden tiheys (SSS) nousevat esille.


### Lisää plottailua

```{r, fig.width=14, fig.height=12}
#plottailua
xyplot(terri~fyear|id, data=data)
boxplot(terri~fyear, data=data)
boxplot(terri~id, data=data)
xyplot(terri~SSS, data=data)
xyplot(terri~open, data=data)
xyplot(terri~cover, data=data)
```


## Mallit

Peruspiirteittäin suunniteltiin mallit näin:

M1 = year  

M2 = year + kov  

M3 = year + kov + weather x year  

M4 = year + kov + pelto x year  

M5 = year + kov + weather x year + pelto x year  


Kov(ariaatit) tarkoittaa SSS, agri5 ja koordinaatteja. ("pakolliset kovariaatit")  
Weather tarkoittaa sadantaa ja lämpötilaa.  
Pelto tarkoittaa shannon-indeksiä ja avoimen maan osuutta (open).

### Nested/crossed, hierarchical ja muita ajatuksia

```{r}
#Aksun esimerkit (näissä mukana NDVI):
#m1=glmmTMB(N ~Year + (1|fYear) + (1|Site), family=nbinom2, data=Embhor) 
#m2=glmmTMB(N ~SSS + Landscape + X + Y + X*Y + Year + (1|fYear) + (1|Site), family=nbinom2, data=Embhor) 
#m3=glmmTMB(N ~SSS + Landscape + X + Y + X*Y + Year*Temp + Year*Rain + Year*NDVI + (1|fYear) + (1|Site), family=nbinom2, data=Embhor)
#m4=glmmTMB(N ~SSS + Landscape + X + Y + X*Y + Year*Cropdiv + Year*Plough + (1|fYear) + (1|Site), family=nbinom2, data=Embhor)
#m5=glmmTMB(N ~SSS + Landscape + X + Y + X*Y + Year*Temp + Year*Rain + Year*NDVI + Year*Cropdiv + Year*Plough + (1|fYear) + (1|Site), family=nbinom2, data=Embhor)
```

Mikään malleista ei aluksi toiminut, koska aineisto oli skaalaamaton. Alla kuitenkin asioita, joita tuli pohdittua ongelmaa selvittäessä:  

Muuttuja 'id' eli jokaisen osapopulaaation yksilöivä tunniste on random-muuttuja koska se saattaa sisältää jotain informaatiota, jota fixed-muuttujat eivät sisällä koska koko populaatio ei ole täydellisesti edustettuna otoksessa.  

Määritelmiä siitä, milloin effect on fixed tai random: "Effects are fixed if they are interesting in themselves or random if there is interest in the underlying population. When a sample exhausts the population, the corresponding variable is fixed; when the sample is a small (i.e., negligible) part of the population the corresponding variable is random".  

Mutta entäpä vuosi?  

Random-efektinä vuosi huomioisi vuosien välisen ajallisen riippuvuuden. Osapopulaatiolla, jolla on monta lauluryhmää yhtenä vuonna, on suuremmalla todennäköisyydellä monta lauluryhmää myös seuraavana vuonna.  
Fixed-efektinä se selittäisi lauluryhmien määrässä tapahtuvaa vaihtelua suoraan. Vuodet ovat erilaisia (esim. tapahtumat Afrikassa vaihtelevat) ja jokin asia, jota emme ole tajunneet mitata voi selittyäkin vuodella.  


Muuttuja sekä fixed että random-tekijänä?  

Lue aiheesta [täältä](https://www.theanalysisfactor.com/mixed-models-predictor-both-fixed-random/). Voiko vuosi siis olla fixed effect vain silloin kun se on interaktiossa jonkun toisen muuttujan kanssa? 


Nested or crossed?

Relatively few mixed effect modeling packages can handle crossed random effects, i.e. those where one level of a random effect can appear in conjunction with more than one level of another effect. (This definition is confusing, and I would happily accept a better one.) A classic example is crossed temporal and spatial effects. If there is random variation among temporal blocks (e.g. years) ‘’and’‘random variation among spatial blocks (e.g. sites),’‘and’‘if there is a consistent year effect across sites and’‘vice versa’’, then the random effects should be treated as crossed. 

Selkeä vastaus lötyy [täältä](https://stats.stackexchange.com/questions/228800/crossed-vs-nested-random-effects-how-do-they-differ-and-how-are-they-specified).


Random-muuttujan havaintojen määrä?  

Joillain osapopulaatioilla on käyty vain kerran, joillain taas täydet 19 kertaa. Jos osapopulaatio on random-tekijä täytyy siitä olla havaintoja useampia. Muuten ei pysty arvioimaan ryhmän sisäistä vaihtelua? Katso kysymys [aiheesta](https://stats.stackexchange.com/questions/242821/how-will-random-effects-with-only-1-observation-affect-a-generalized-linear-mixe). Vastaus on kai, että ei haittaa, kunhan vaihtelun saa arvioitua muista osapopulaatioista, joista on useampia havaintoja. 

Muuttujien skaalaaminen?

Vuoden keskittäminen? Vuosi 2000 olisi baseline ja siitä eteenpäin vuosi 1,2,3 jne. Tai Cyear = year-mean(year). Uusi muuttuja.

### GLMM-mallit

Skaalataan aineisto ja kokeillaan glmm-malleja. Sovitetaan viisi hypoteesiemme mukaista glmm-mallia ja tulostetaan niiden AICc-taulukko: 

```{r}
dataS=data %>%
   mutate_at(c(2,3,5,6,7,9:18,19,20), funs(c(scale(.))))


M1=glmmTMB(terri ~ year + (1|fyear)+ (1|id), family=nbinom2, data=dataS)

M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + (1|fyear) + (1|id), family=nbinom2, data=dataS)

M3=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec  + (1|fyear)  + (1|id), family=nbinom2, data=dataS)

M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS)

M5=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS)

output1<-model.sel(M1,M2,M3,M4,M5) 

# AICc Table
output1
```

Taulukon mukaan mallit M4 ja M5 ovat parhaimpia, 1.83 AICc yksikön erolla toisistaan. Mallit eroavat toisistaan vuoden ja lämpötilan sekä sadannan interaktioiden suhteen. M4 on yksinkertaisempi eli ilman ilmastomuuttujia.

Tehdään model averaging M4 ja M5 malleilla:

```{r}
output2=model.sel(M4,M5)

#tehdään model averaging
summary(model.avg(output2, revised.var = TRUE))
```

Taulukon tulkinta on hieman epäselvää mulle. Taulukkohan vihjaa ettei interaktiot olisi merkittäviä, mutta mehän halutaan tutkia nimenomaan interaktioita koska ne linkittyvät asioihin, jotka kertovat reviirien lukumäärän vuosittaisesta muutoksesta. Muuttujien tutkiminen ilman interaktiota vuoden kanssa ei ole tässä tapauksessa mielekästä, koska se selittäisi ennemminkin asioita, jotka vaikuttavat reviirien absoluuttiseen lukumäärään, ei muutokseen. Ko,kö?

```{r}
summary(M5)
summary(M4)
```

Malleja pitäisi visualisoida jotenkin...


### GAM-malli,  Tweedie

Päätettiin kokeilla mallinnusta niin, että selitettävänä muuttujana onkin reviirien tiheys. Näin osapopulaatioiden vaihteleva pinta-ala saadaan paremmin huomioitua. Osapopulaatiohan oli jo aikaisemminkin random-mmuuttujana, joten pinta-alan aiheuttama vaihtelu muuttujissa oli huomioitu jo jollain tasolla, mutta ei ehkä riittävästi.

SSS eli pienten rakenteiden lukumäärä tai pituudet ovat myös suhteutettu osapopulaation pinta-alaan. Mietin, tuleeko pinta-ala tässä tapauksessa huomioitua kahteen kertaan?

Tweedie-asiaa [netissä](https://stat.ethz.ch/R-manual/R-patched/library/mgcv/html/Tweedie.html).

Luodaan uusi muuttuja 'terriD', joka on reviirien lkm jaettuna osapopulaation pinta-alalla (reviiriä/km2):

```{r}
#reviirien tiheys
dataS$terriD=dataS$terri/dataS$area
summary(dataS$terriD)
```

Mallit..

```{r}
G1=gamm(terriD ~ year + (1|fyear)+ (1|id), family=nbinom2, data=dataS)

M2=glmmTMB(terriD ~ SSS + agri5 + X*Y + year + (1|fyear) + (1|id), family=nbinom2, data=dataS)

M3=glmmTMB(terriD ~ SSS + agri5 + X*Y + year*temp + year*prec  + (1|fyear)  + (1|id), family=nbinom2, data=dataS)

M4=glmmTMB(terriD ~ SSS + agri5 + X*Y + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS)

M5=glmmTMB(terriD ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS)

```


### Neo-muuttuja erikseen

Lägi-malli. Viime vuoden viljely osapopulaation alueella.
Aineisto kolmeen maantieteelliseen alueeseen. Alueiden vertailu.

```{r}
#neot erikseen
N1=glmmTMB(terri ~ neo * year + X * Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
summary(N1)

N2=glmmTMB(terri ~ neo + year + X + Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
AIC(N1,N2)

N3=glmmTMB(terri ~ neo + year  + Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
AIC(N2,N3)

N4=glmmTMB(terri ~ neo + Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
AIC(N3,N4)

N5=glmmTMB(terri ~ neo + year  + (1|fyear) + (1|id), family=nbinom2, data=dataS)
AIC(N3,N5)

N6=glmmTMB(terri ~  year + Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
AIC(N3,N6)

summary(N3)
summary(N6)
```



```{r}



```
