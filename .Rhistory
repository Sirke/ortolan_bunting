#m5=glmmTMB(N ~SSS + Landscape + X + Y + X*Y + Year*Temp + Year*Rain + Year*NDVI + Year*Cropdiv + Year*Plough + (1|fYear) + (1|Site), family=nbinom2, data=Embhor)
dataS=data %>%mutate_at(c(2:3,5:7,9:14,20:21), funs(c(scale(.))))
M1=glmmTMB(terri ~ year + (1|fyear)+ (1|id), family=nbinom2, data=dataS, REML=FALSE)
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M3=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec  + (1|fyear)  + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M5=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
output1<-model.sel(M1,M2,M3,M4,M5)
# AICc Table
output1
output2=model.sel(M4,M5)
#tehdään model averaging
summary(model.avg(output2, revised.var = TRUE))
summary(M4)
#malli uudelleen, ML-asetuksella
M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shan + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
#plot(M4,add.smooth = F,which =1)
E<-resid(M4)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shan,E,xlab = "shan",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
par(op)
M1=glmmTMB(terri ~ year + offset(log(area)) + (1|fyear)+ (1|id), family=nbinom2, data=dataS, REML=FALSE)
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS,REML=FALSE)
M3=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec  + offset(log(area))+ (1|fyear)  + (1|id), family=nbinom2, data=dataS,REML=FALSE)
M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shan + year*open + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS,REML=FALSE)
M5=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shan + year*open + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS,REML=FALSE)
output1<-model.sel(M1,M2,M3,M4,M5)
output1
output2=model.sel(M4,M2)
#tehdään model averaging
summary(model.avg(output2, revised.var = TRUE))
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS)
summary(M2)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shan,E,xlab = "shan",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
par(op)
#reviirien tiheys
dataS$terriD=dataS$terri/dataS$area
summary(dataS$terriD)
#joku smootheri mallissa täytyy olla, vai täytyykö? gamm4 näyttää toimivan ilmankin. mgcv-paketin gamm ei toiminut.
#vai pitäisikö perusmallin olla glmm? jos ainut selittävä tekijä on year.
M1=gamm4(terri ~ year + offset(log(area)), random= ~(1 + year|id), family=nbinom2, data=dataS) #gamm4-funktiolla random-argumentti on vähän erilainen
M1=gamm(terri ~ year, offset=log(area), random= list(year=~1,id=~1), family=nbinom2, data=dataS) # tää random on varmaan väärin
M1=gamm(terri ~ year, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS) #oisko tämä syntaksi oikein?
M2=gamm(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)) , random= list(id=~1+year), family=nbinom2, data=dataS)
getwd()
paketit<-c("readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","glmmTMB","lme4","MASS","MuMIn","mgcv","gamm4")
lapply(paketit,library,character.only=T)
M1=gamm4(terri ~ year, offset=log(area), random= ~(1 + year|id), family=nbinom2, data=dataS) #gamm4-funktiolla random-argumentti on vähän erilainen
M1=gamm4(terri ~ year+ offset(log(area)), random= ~(1 + year|id), family=nbinom2, data=dataS) #gamm4-funktiolla random-argumentti on vähän erilainen
M1=gamm(terri ~ year, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS) #oisko tämä syntaksi oikein?
M2=gamm(terri ~ SSS + agri5*year + s(Y) + s(X) + year , offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
M3=gamm(terri ~ SSS + agri5*year + s(Y) + s(X)+ year*temp + year*prec , offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
M4=gamm(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
M5=gamm(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
output1<-model.sel(M1,M2,M3,M4,M5)
output1<-model.sel(M1,M2,M3,M4,M5)
getwd()
paketit<-c("readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","glmmTMB","lme4","MASS","MuMIn","mgcv","gamm4")
lapply(paketit,library,character.only=T)
getwd()
paketit<-c("readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","glmmTMB","lme4","MASS","MuMIn","mgcv","gamm4")
lapply(paketit,library,character.only=T)
dataS=data %>%mutate_at(c(2:3,5:7,9:14,20:21), funs(c(scale(.))))
data<-read.csv("OrtolanBunting.csv")
names(data)
str(data)
summary(data)
#tarkasta kaikkien luokkien muoto
data$id<-as.factor(data$id)
#vuodelle oma faktori-muuttuja
data$fyear<-as.factor(data$year)
dataS=data %>%mutate_at(c(2:3,5:7,9:14,20:21), funs(c(scale(.))))
AllThetas <- c(0.1, 0.2, 0.3, 0.4, 0.6, 1, 2, 5, 10)
AICs <- vector(length = 9)
i <- 1
for (MyTheta in AllThetas) {
M1 <- gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)),
random =~ (1 + year| id),
family = negbin(theta = MyTheta),
data = dataS)
AICs[i] <- AIC(M1$mer)  #<---
i <- i + 1
}
plot(x = AllThetas,
y = AICs,
xlab = "Theta value in NB GAMM",
ylab = "AIC",
cex.lab = 1.5,
type = "l"
)
M6 <- gam(NCalls ~ (terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"), #miten tähän laitetaan random intercept ja slope??s(x,g,bs="re")
M6 <- gam(NCalls ~ (terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"),family = nb(),data = dataS)
M6 <- gam(NCalls ~ (terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
M6 <- gam(NCalls ~ (terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS))
M6 <- gam(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
summary(M6)
Theta <- M6$family$getTheta(TRUE)
# If you want then you can run M4 again with the optimal theta.
M4 <- gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)),
random = ~(1 + year|id),
family = negbin(theta = Theta),
data = dataS)
summary(M4$gam)
summary(M4$mer)
gam.vcomp(M6)
Theta
Theta
#joku smootheri mallissa täytyy olla, vai täytyykö? gamm4 näyttää toimivan ilmankin. mgcv-paketin gamm ei toiminut.
M1=gamm4(terri ~ year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS) #gamm4-funktiolla random-argumentti on vähän erilainen, offset toimii myös erilailla
M2=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M2=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M3=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X)+ year*temp + year*prec + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M5=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M6 <- gam(terri ~ year + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
summary(M6)
Theta <- M6$family$getTheta(TRUE)
# If you want then you can run M4 again with the optimal theta.
M4 <- gamm4(terri ~ year + offset(log(area)),
random = ~(1 + year|id),
family = negbin(theta = Theta),
data = dataS)
# M6 and M4 should now give similar results.
summary(M6)
summary(M4$gam)
summary(M4$mer)
gam.vcomp(M6)
Theta
M6 <- gam(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
M6 <- gam(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
Theta <- M6$family$getTheta(TRUE)
M6 <- gam(terri ~ year + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
M6 <- gam(terri ~ year + offset(log(area)) + s(year,id, bs =  "re"), family = nb(),data = dataS)
Theta2 <- M6$family$getTheta(TRUE)
M1=gamm4(terri ~ year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M2=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M3=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X)+ year*temp + year*prec + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
M5=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
AIC(M1$mer, M2$mer, M3$mer, M4$mer, M5$mer)
G1=gamm4(terri ~ year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G2=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G3=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X)+ year*temp + year*prec + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G5=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
AIC(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
G4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
getwd()
paketit<-c("readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","glmmTMB","lme4","MASS","MuMIn","mgcv","gamm4")
lapply(paketit,library,character.only=T)
data<-read.csv("OrtolanBunting.csv")
names(data)
str(data)
summary(data)
#tarkasta kaikkien luokkien muoto
data$id<-as.factor(data$id)
#vuodelle oma faktori-muuttuja
data$fyear<-as.factor(data$year)
#outliers
dotchart(data$terri, main= "N territories")
dotchart(data$prec, main= "precipitation")
dotchart(data$temp, main= "temperature")
dotchart(data$open, main= "open (spring sown)")
dotchart(data$SSS, main= "SSS (small-scale structures)")
dotchart(data$shan, main= "shannon")
dotchart(data$shanG, main= "shannon, crop types")
hist(data$terri)
table(data$terri)
sort(table(data$id))
#relationships
pairs.panels(data[,c(3:22)])
#plottailua
xyplot(terri~fyear|id, data=data)
boxplot(terri~fyear, data=data)
dataS=data %>%mutate_at(c(2:3,5:7,9:14,20:21), funs(c(scale(.))))
M1=glmmTMB(terri ~ year + (1|fyear)+ (1|id), family=nbinom2, data=dataS, REML=FALSE)
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M3=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec  + (1|fyear)  + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shanG + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M5=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shanG + year*open + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
output1<-model.sel(M1,M2,M3,M4,M5)
output1
output2=model.sel(M4,M2)
summary(model.avg(output2, revised.var = TRUE))
summary(M2)
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
#plot(M4,add.smooth = F,which =1)
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shan,E,xlab = "shan",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
par(op)
M1=glmmTMB(terri ~ year + offset(log(area)) + (1|fyear)+ (1|id), family=nbinom2, data=dataS, REML=FALSE)
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS,REML=FALSE)
M3=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec  + offset(log(area))+ (1|fyear)  + (1|id), family=nbinom2, data=dataS,REML=FALSE)
M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shanG + year*open + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS,REML=FALSE)
M5=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shanG + year*open + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS,REML=FALSE)
output1<-model.sel(M1,M2,M3,M4,M5)
output1
output2=model.sel(M2,M3,M4)
summary(model.avg(output2, revised.var = TRUE))
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
#plot(M4,add.smooth = F,which =1)
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shanG,E,xlab = "shan",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
par(op)
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + (1|fyear) + (1|id), family=nbinom2, data=dataS)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
#plot(M4,add.smooth = F,which =1)
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shanG,E,xlab = "shanG",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
par(op)
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS)
summary(M2)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shanG,E,xlab = "shanG",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
par(op)
M1=glmmTMB(terri ~ year + log(area) + (1|fyear)+ (1|id), family=nbinom2, data=dataS, REML=FALSE)
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + log(area)+ (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M3=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec  + log(area)+ (1|fyear)  + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M4=glmmTMB(terri ~ SSS + agri5 + X*Y + year*shanG + year*open + log(area)+ (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M5=glmmTMB(terri ~ SSS + agri5 + X*Y + year*temp + year*prec + year*shanG + year*open + log(area) + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
output1<-model.sel(M1,M2,M3,M4,M5)
output1
output2=model.sel(M3,M2)
#tehdään model averaging
summary(model.avg(output2, revised.var = TRUE))
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ SSS + agri5 + X*Y + year + log(area)+ (1|fyear) + (1|id), family=nbinom2, data=dataS)
summary(M2)
op<-par(mfrow=c(3,3),mar=c(5,4,1,2))
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$SSS,E,xlab = "SSS",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shanG,E,xlab = "shanG",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
plot(log(dataS$area),E,xlab = "log(area)",ylab="residuals")
par(op)
M1=glmmTMB(terri ~ year + offset(log(area)) + (1|fyear)+ (1|id), family=nbinom2, data=dataS, REML=FALSE)
M2=glmmTMB(terri ~ Abuild + Astream + Aroad + Ariver + agri5 + X*Y + year + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M3=glmmTMB(terri ~ Abuild + Astream + Aroad + Ariver + agri5 + X*Y + year*temp + year*prec  + offset(log(area))+ (1|fyear)  + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M4=glmmTMB(terri ~ Abuild + Astream + Aroad + Ariver + agri5 + X*Y + year*shanG + year*open + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
M5=glmmTMB(terri ~ Abuild + Astream + Aroad + Ariver + agri5 + X*Y + year*temp + year*prec + year*shanG + year*open + offset(log(area)) + (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
output1<-model.sel(M1,M2,M3,M4,M5)
output1
output2=model.sel(M3,M2)
#tehdään model averaging
summary(model.avg(output2, revised.var = TRUE))
#malli uudelleen, ML-asetuksella
M2=glmmTMB(terri ~ Abuild + Astream + Aroad + Ariver + agri5 + X*Y + year + offset(log(area))+ (1|fyear) + (1|id), family=nbinom2, data=dataS, REML=FALSE)
summary(M2)
op<-par(mfrow=c(4,3),mar=c(5,4,1,2))
E<-resid(M2)
hist(E, xlab = "residuals",main = "")
plot(dataS$Abuild,E,xlab = "buildings",ylab="residuals")
plot(dataS$Astream,E,xlab = "streams",ylab="residuals")
plot(dataS$Ariver,E,xlab = "rivers",ylab="residuals")
plot(dataS$Aroad,E,xlab = "roads",ylab="residuals")
plot(dataS$year,E,xlab = "year",ylab="residuals")
plot(dataS$shanG,E,xlab = "shanG",ylab="residuals")
plot(dataS$agri5,E,xlab = "agri5",ylab="residuals")
plot(dataS$open,E,xlab = "open",ylab="residuals")
plot(dataS$X,E,xlab = "X",ylab="residuals")
plot(dataS$Y,E,xlab = "Y",ylab="residuals")
plot(log(dataS$area),E,xlab = "log(area)",ylab="residuals")
par(op)
#reviirien tiheys
dataS$terriD=dataS$terri/dataS$area
summary(dataS$terriD)
#relationships
pairs.panels(dataS[,c(3:22)])
pairs.panels(dataS[,c("terriD","fyear","agri5","prec","temp","shan","open","SSS","X","Y")])
ggplot(dataS, aes(x=year,y=terriD))+ geom_point() + geom_smooth()
G1=gam(terriD ~  year + s(fyear,bs="re") + s(id,bs="re"), data=dataS, family=tw, REML=FALSE)
G2=gam(terriD ~  year + agri5 + SSS + s(Y) + s(X) + s(fyear,bs="re") + s(id,bs="re"), data=dataS, family=tw, REML=FALSE)
G3=gam(terriD ~ agri5 + SSS + s(Y) + s(X) + year*temp + year*prec + s(fyear,bs="re") + s(id,bs="re"), data=dataS, family=tw, REML=FALSE)
G4=gam(terriD ~ agri5 + SSS + s(Y) + s(X) + year*shanG + year*open + s(fyear,bs="re") + s(id,bs="re"), data=dataS, family=tw, REML=FALSE)
G5=gam(terriD ~ agri5 + SSS + s(Y) + s(X) + year*shanG + year*open + year*temp + year*prec + s(fyear,bs="re") + s(id,bs="re"), data=dataS, family=tw, REML=FALSE)
AIC(G1,G2,G3,G4,G5)
summary(G2)
plot(G2)
G2$gam
M0 <- gam(terri ~ year + s(id, bs="re") + s(year,id, bs ="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
M1 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(),data= dataS, method = "ML")
M2 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + year*temp + year*prec + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
M3 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + year*shanG + year*open + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
M4 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + year*temp + year*prec + year*shanG + year*open + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
AIC(M0,M1,M2,M3,M4)
summary(M2)
plot(M2)
M1 <- gam(terri ~ year + s(id, bs="re") + s(year,id, bs ="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
M2 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(),data= dataS, method = "ML")
M3 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + year*temp + year*prec + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
M4 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + year*shanG + year*open + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
M5 <- gam(terri ~ SSS + agri5*year + s(Y, bs ="cs") + s(X, bs ="cs") + year*temp + year*prec + year*shanG + year*open + s(id, bs="re") + s(year,id, bs="re"), offset=log(area), family = nb(), data= dataS, method = "ML")
AIC(M0,M1,M2,M3,M4)
AIC(M1,M2,M3,M4,M5)
summary(M3)
summary(M5)
plot(M3)
gam.check(M3)
AllThetas <- c(0.1, 0.2, 0.3, 0.4, 0.6, 1, 2, 5, 10)
AICs <- vector(length = 9)
i <- 1
for (MyTheta in AllThetas) {
M1 <- gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shanG + year*open + offset(log(area)),
random =~ (1 + year| id),
family = negbin(theta = MyTheta),
data = dataS)
AICs[i] <- AIC(M1$mer)  #<---
i <- i + 1
}
# And plot the results
plot(x = AllThetas,
y = AICs,
xlab = "Theta value in NB GAMM",
ylab = "AIC",
cex.lab = 1.5,
type = "l"
)
#thetan voisi arvioida sovittamalla mallin GAM:lla eli random tekijä smootheriksi. Mutta mikä malli tässä pitäisi olla? Monimutkaisin?
M6 <- gam(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shanG + year*open + offset(log(area)) + s(id, bs="re") + s(year,id, bs="re"), family = nb(),data = dataS)
#thetan voisi arvioida sovittamalla mallin GAM:lla eli random tekijä smootheriksi. Mutta mikä malli tässä pitäisi olla? Monimutkaisin?
M6 <- gam(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shanG + year*open + offset(log(area)) + s(id, bs="re") + s(year,id, bs="re"), family = nb(),data = dataS)
summary(M6)
Theta <- M6$family$getTheta(TRUE)
# If you want then you can run M4 again with the optimal theta.
M7 <- gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shanG + year*open + offset(log(area)),
random = ~(1 + year|id),
family = negbin(theta = Theta),
data = dataS)
# M6 and M4 should now give similar results.
summary(M6)
summary(M7$gam)
summary(M7$mer)
gam.vcomp(M6)
Theta
M8 <- gam(terri ~ year + offset(log(area)) + s(id, bs="re") + s(year,id, bs="re"), family = nb(), data = dataS)
summary(M8)
Theta2 <- M8$family$getTheta(TRUE)
# If you want then you can run M4 again with the optimal theta.
M9 <- gamm4(terri ~ year + offset(log(area)),
random = ~(1 + year|id),
family = negbin(theta = Theta2),
data = dataS)
Theta2
#varsinaiset mallit, joissa theta arvioitu gam-mallin avulla
G1=gamm4(terri ~ year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G2=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G3=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X)+ year*temp + year*prec + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G5=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shan + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
AIC(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
anova(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
AIC(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
anova(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
summary(G3$gam)
summary(G3$mer)
plot(G3$gam)
#Check dispersion parameter
p <- sum(G3$gam$edf) + 1 + 1 #theta and sigma id,  MITÄ TÄHÄN PITÄISI KIRJATA, tuleeko crossed random effectseistä vielä yksi degree of freedom lisää? vielä yksi +1?
N <- nrow(dataS)
E4 <- resid(G3$mer, type = "pearson")
Overdisp <- sum(E4^2) / (N - p)
Overdisp
#Plot residuals vs ...
plot(x = dataS$X,
y = E4,
xlab = "X",
ylab = "Pearson residuals")
abline(h = 0, lty = 2)
#Plot residuals vs ...
plot(x = dataS$Y,
y = E4,
xlab = "Y",
ylab = "Pearson residuals")
abline(h = 0, lty = 2)
#Is there a non-linear pattern in here?
T1 <- gam(E4 ~ s(Y), data = dataS)
summary(T1)
plot(T1)
abline(h = 0, lty = 2)
G1=gamm(terri ~ year, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G2=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr") + year, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G3=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr")+ year*temp + year*prec , offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G4=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr") + year*shan + year*open, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G5=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr") + year*temp + year*prec + year*shan + year*open, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
#Check dispersion parameter
p <- sum(G3$gam$edf) + 1 + 1 #theta and sigma id,  MITÄ TÄHÄN PITÄISI KIRJATA, tuleeko crossed random effectseistä vielä yksi degree of freedom lisää? vielä yksi +1?
N <- nrow(dataS)
E4 <- resid(G3$mer, type = "pearson")
Overdisp <- sum(E4^2) / (N - p)
Overdisp
#Plot residuals vs ...
plot(x = dataS$X,
y = E4,
xlab = "X",
ylab = "Pearson residuals")
abline(h = 0, lty = 2)
#Plot residuals vs ...
plot(x = dataS$Y,
y = E4,
xlab = "Y",
ylab = "Pearson residuals")
abline(h = 0, lty = 2)
#Is there a non-linear pattern in here?
T1 <- gam(E4 ~ s(Y), data = dataS)
AIC(G1$lme, G2$lme, G3$lme, G4$lme, G5$lme)
summary(G4$gam)
summary(G4$mer)
plot(G4$gam)
#varsinaiset mallit, joissa theta arvioitu gam-mallin avulla
G1=gamm4(terri ~ year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G2=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G3=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X)+ year*temp + year*prec + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G4=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*shanG + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
G5=gamm4(terri ~ SSS + agri5*year + s(Y) + s(X) + year*temp + year*prec + year*shanG + year*open + offset(log(area)), random= ~(1 + year|id), family=negbin(theta=Theta), data=dataS)
AIC(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
anova(G1$mer, G2$mer, G3$mer, G4$mer, G5$mer)
summary(G3$gam)
summary(G3$mer)
plot(G3$gam)
#Check dispersion parameter
p <- sum(G3$gam$edf) + 1 + 1 #theta and sigma id,  MITÄ TÄHÄN PITÄISI KIRJATA, tuleeko crossed random effectseistä vielä yksi degree of freedom lisää? vielä yksi +1?
N <- nrow(dataS)
E4 <- resid(G3$mer, type = "pearson")
Overdisp <- sum(E4^2) / (N - p)
Overdisp
#Plot residuals vs ...
plot(x = dataS$X,
y = E4,
xlab = "X",
ylab = "Pearson residuals")
abline(h = 0, lty = 2)
#Plot residuals vs ...
plot(x = dataS$Y,
y = E4,
xlab = "Y",
ylab = "Pearson residuals")
abline(h = 0, lty = 2)
#Is there a non-linear pattern in here?
T1 <- gam(E4 ~ s(Y), data = dataS)
summary(T1)
plot(T1)
abline(h = 0, lty = 2)
G1=gamm(terri ~ year, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G2=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr") + year, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G3=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr")+ year*temp + year*prec , offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G4=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr") + year*shanG + year*open, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
G5=gamm(terri ~ SSS + agri5*year + s(Y,bs="cr") + s(X,bs="cr") + year*temp + year*prec + year*shanG + year*open, offset=log(area), random= list(id=~1+year), family=nbinom2, data=dataS)
AIC(G1$lme, G2$lme, G3$lme, G4$lme, G5$lme)
summary(G4$gam)
summary(G4$mer)
plot(G4$gam)
summary(G2$gam)
summary(G2$mer)
plot(G2$gam)
